<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SUPERBET Odds Bar</title>

<style>
:root{
  --red:#E31B23;
  --redDark:#B31319;
  --white:#FFFFFF;
  --softWhite:rgba(255,255,255,.85);
}

*{ box-sizing:border-box; }

html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  background:transparent;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

/* BARRA FULL */
.odds-bar{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  height:60px;
  background: linear-gradient(90deg, var(--red), var(--redDark));
  display:flex;
  align-items:center;
}

/* CONTEÚDO CENTRAL ABSOLUTO */
.odds-inner{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  align-items:center;
  gap:60px;
  white-space:nowrap; /* nunca quebra */
}

/* LOGO */
.brand img{
  height:140px;
  filter: brightness(0) invert(1);
}

/* ODDS */
.odds{
  display:flex;
  align-items:center;
  gap:50px;
}

.odd-item{
  display:flex;
  align-items:center;
  gap:14px;
  position:relative;
  padding-left:16px;
}

.odd-item::before{
  content:"";
  position:absolute;
  left:0;
  top:8px;
  bottom:8px;
  width:4px;
  background:var(--white);
  border-radius:2px;
}

.odd-value{
  font-size:22px;
  font-weight:900;
  color:var(--white);
  letter-spacing:.05em;
}

.odd-meta{
  display:flex;
  flex-direction:column;
  line-height:1.05;
}

.odd-team{
  font-size:15px;
  font-weight:800;
  color:var(--white);
}

.odd-label{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.18em;
  color:var(--softWhite);
}

.sep{
  width:1px;
  height:26px;
  background:rgba(255,255,255,.25);
}
</style>
</head>

<body>

<!-- ✅ Pode continuar setando aqui como fallback -->
<div
  class="odds-bar"
  data-endpoint-base="https://production-superbet-offer-br.freetls.fastly.net/v2/pt-BR/events/"
  data-event-id="12107483"
>
  <div class="odds-inner">

    <div class="brand">
      <img src="superbet-logo.svg" alt="SUPERBET">
    </div>

    <div class="odds">

      <div class="odd-item">
        <div class="odd-value" id="oddHome">—</div>
        <div class="odd-meta">
          <div class="odd-team" id="teamHome">—</div>
          <div class="odd-label">Casa</div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="odd-item">
        <div class="odd-value" id="oddDraw">—</div>
        <div class="odd-meta">
          <div class="odd-team">X</div>
          <div class="odd-label">Empate</div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="odd-item">
        <div class="odd-value" id="oddAway">—</div>
        <div class="odd-meta">
          <div class="odd-team" id="teamAway">—</div>
          <div class="odd-label">Fora</div>
        </div>
      </div>

    </div>

  </div>
</div>

<script>
(function(){
  const bar = document.querySelector(".odds-bar");
  const $ = (id) => document.getElementById(id);

  const elOddHome = $("oddHome");
  const elOddDraw = $("oddDraw");
  const elOddAway = $("oddAway");
  const elTeamHome = $("teamHome");
  const elTeamAway = $("teamAway");

  // ✅ NOVO: se vier ?id= na URL, sobrescreve o data-event-id.
  // Se não vier, fica como estava (baseline).
  (function applyIdFromUrl(){
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    if (!id) return; // sem ?id= -> segue o data-event-id do HTML
    const clean = String(id).replace(/\D/g, "");
    if (!clean) return;
    bar.setAttribute("data-event-id", clean); // dispara MutationObserver também
  })();

  // pega times do matchName (no seu JSON costuma vir "TIME A·TIME B")
  function splitTeams(matchName){
    const s = String(matchName || "").trim();
    if (!s) return ["—","—"];
    if (s.includes("·")) return s.split("·").map(x => x.trim()).slice(0,2);
    if (s.includes(" x ")) return s.split(" x ").map(x => x.trim()).slice(0,2);
    if (s.includes(" vs ")) return s.split(" vs ").map(x => x.trim()).slice(0,2);
    return [s, "—"];
  }

  // ✅ FIX: Extrai 1/X/2 escolhendo 1 único market (evita X errado de outro mercado)
  function extract1X2(item){
    const odds = Array.isArray(item?.odds) ? item.odds : [];

    // tenta pegar mercado "Resultado Final" (ou equivalente)
    const candidates = odds.filter(o => {
      const mn = String(o?.marketName || "").toLowerCase();
      return mn.includes("resultado final") || (mn.includes("resultado") && mn.includes("final"));
    });

    const pool = candidates.length ? candidates : odds;

    // agrupa por marketUuid (preferido) ou marketId
    const groups = new Map();
    for (const o of pool) {
      const key = o?.marketUuid ?? o?.marketId;
      if (key == null) continue;
      if (!groups.has(key)) groups.set(key, []);
      groups.get(key).push(o);
    }

    // escolhe um grupo que tenha 1, X e 2
    let list = [];
    for (const g of groups.values()) {
      const names = g.map(x => String(x?.name ?? "").trim().toUpperCase());
      const codes = g.map(x => String(x?.code ?? "").trim().toUpperCase());

      const has1 = names.includes("1") || codes.includes("1");
      const has2 = names.includes("2") || codes.includes("2");
      const hasX = names.includes("X") || codes.includes("0") || codes.includes("X") || names.some(n => n.includes("EMPATE"));

      if (has1 && has2 && hasX) { list = g; break; }
    }

    if (!list.length) return { "1": null, "X": null, "2": null };

    const out = { "1": null, "X": null, "2": null };

    for (const o of list) {
      const label = String(o?.name ?? "").trim().toUpperCase(); // "1","X","2"
      const code  = String(o?.code ?? "").trim().toUpperCase();
      const price = Number(String(o?.price).replace(",", "."));
      if (!Number.isFinite(price)) continue;

      if (label === "1" || code === "1") out["1"] = price;
      else if (label === "2" || code === "2") out["2"] = price;
      else if (label === "X" || code === "0" || code === "X" || label.includes("EMPATE")) out["X"] = price;
    }

    return out;
  }

  function formatOdd(v){
    return (typeof v === "number" && Number.isFinite(v)) ? v.toFixed(2) : "—";
  }

  async function update(){
    try{
      const base = bar.dataset.endpointBase;
      const eventId = bar.dataset.eventId;
      if (!eventId) return; // segurança extra

      const url = base + encodeURIComponent(eventId);

      const res = await fetch(url, { cache: "no-store", headers: { "accept": "application/json" } });
      if (!res.ok) throw new Error("HTTP " + res.status);

      const json = await res.json();
      const item = json?.data?.[0];
      if (!item) throw new Error("Sem data[0]");

      const [home, away] = splitTeams(item.matchName);
      elTeamHome.textContent = (home || "—").toUpperCase();
      elTeamAway.textContent = (away || "—").toUpperCase();

      const phase = String(item?.metadata?.status || "").toUpperCase(); // STARTED / NOT_STARTED / FINISHED
      const odds = extract1X2(item);

      // Se finalizada: não preencher odds
      if (phase === "FINISHED") {
        elOddHome.textContent = "—";
        elOddDraw.textContent = "—";
        elOddAway.textContent = "—";
        return;
      }

      // Ao vivo ou pré-jogo: preenche normalmente (se tiver)
      elOddHome.textContent = formatOdd(odds["1"]);
      elOddDraw.textContent = formatOdd(odds["X"]);
      elOddAway.textContent = formatOdd(odds["2"]);

    } catch (err) {
      // em broadcast: não “pisca”, mantém o último valor renderizado
      console.warn("[odds-bar] update failed:", err);
    }
  }

  // ✅ se você mudar data-event-id no HTML (ou via DevTools), atualiza tudo automaticamente
  const mo = new MutationObserver((mut) => {
    for (const m of mut) {
      if (m.type === "attributes" && m.attributeName === "data-event-id") {
        // limpa e busca imediatamente
        elOddHome.textContent = "—";
        elOddDraw.textContent = "—";
        elOddAway.textContent = "—";
        elTeamHome.textContent = "—";
        elTeamAway.textContent = "—";
        update();
      }
    }
  });
  mo.observe(bar, { attributes: true });

  update();
  setInterval(update, 1000);
})();
</script>

</body>
</html>
